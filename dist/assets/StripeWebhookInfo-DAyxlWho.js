import{j as t,m as fe}from"./motion-DEFBAXox.js";import{R as d,a as C}from"./vendor-C4jSHSwK.js";import{u as W,s as M,i as L,j as F,a as he}from"./index-DicW4zRf.js";import{l as ye,S as q}from"./stripe-service-jIMPwR8k.js";import{P as f}from"./index-D-twCb4o.js";import{F as xe}from"./PlusIcon-ySxxH9nU.js";import{F as ve}from"./TrashIcon-CkYu8bNi.js";import{F as ge}from"./ClipboardIcon-Ddvdg0PT.js";function K(n,e){var r=Object.keys(n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(n);e&&(s=s.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),r.push.apply(r,s)}return r}function H(n){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};e%2?K(Object(r),!0).forEach(function(s){Q(n,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):K(Object(r)).forEach(function(s){Object.defineProperty(n,s,Object.getOwnPropertyDescriptor(r,s))})}return n}function R(n){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?R=function(e){return typeof e}:R=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},R(n)}function Q(n,e,r){return e in n?Object.defineProperty(n,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[e]=r,n}function X(n,e){return be(n)||je(n,e)||Ce(n,e)||Se()}function be(n){if(Array.isArray(n))return n}function je(n,e){var r=n&&(typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"]);if(r!=null){var s=[],i=!0,o=!1,c,m;try{for(r=r.call(n);!(i=(c=r.next()).done)&&(s.push(c.value),!(e&&s.length===e));i=!0);}catch(a){o=!0,m=a}finally{try{!i&&r.return!=null&&r.return()}finally{if(o)throw m}}return s}}function Ce(n,e){if(n){if(typeof n=="string")return J(n,e);var r=Object.prototype.toString.call(n).slice(8,-1);if(r==="Object"&&n.constructor&&(r=n.constructor.name),r==="Map"||r==="Set")return Array.from(n);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return J(n,e)}}function J(n,e){(e==null||e>n.length)&&(e=n.length);for(var r=0,s=new Array(e);r<e;r++)s[r]=n[r];return s}function Se(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var j=function(e,r,s){var i=!!s,o=d.useRef(s);d.useEffect(function(){o.current=s},[s]),d.useEffect(function(){if(!i||!e)return function(){};var c=function(){o.current&&o.current.apply(o,arguments)};return e.on(r,c),function(){e.off(r,c)}},[i,r,e,o])},D=function(e){var r=d.useRef(e);return d.useEffect(function(){r.current=e},[e]),r.current},k=function(e){return e!==null&&R(e)==="object"},we=function(e){return k(e)&&typeof e.then=="function"},Ne=function(e){return k(e)&&typeof e.elements=="function"&&typeof e.createToken=="function"&&typeof e.createPaymentMethod=="function"&&typeof e.confirmCardPayment=="function"},V="[object Object]",Ee=function n(e,r){if(!k(e)||!k(r))return e===r;var s=Array.isArray(e),i=Array.isArray(r);if(s!==i)return!1;var o=Object.prototype.toString.call(e)===V,c=Object.prototype.toString.call(r)===V;if(o!==c)return!1;if(!o&&!s)return e===r;var m=Object.keys(e),a=Object.keys(r);if(m.length!==a.length)return!1;for(var v={},g=0;g<m.length;g+=1)v[m[g]]=!0;for(var h=0;h<a.length;h+=1)v[a[h]]=!0;var p=Object.keys(v);if(p.length!==m.length)return!1;var l=e,u=r,w=function(P){return n(l[P],u[P])};return p.every(w)},Z=function(e,r,s){return k(e)?Object.keys(e).reduce(function(i,o){var c=!k(r)||!Ee(e[o],r[o]);return s.includes(o)?(c&&console.warn("Unsupported prop change: options.".concat(o," is not a mutable property.")),i):c?H(H({},i||{}),{},Q({},o,e[o])):i},null):null},ee="Invalid prop `stripe` supplied to `Elements`. We recommend using the `loadStripe` utility from `@stripe/stripe-js`. See https://stripe.com/docs/stripe-js/react#elements-props-stripe for details.",G=function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ee;if(e===null||Ne(e))return e;throw new Error(r)},ke=function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ee;if(we(e))return{tag:"async",stripePromise:Promise.resolve(e).then(function(i){return G(i,r)})};var s=G(e,r);return s===null?{tag:"empty"}:{tag:"sync",stripe:s}},Pe=function(e){!e||!e._registerWrapper||!e.registerAppInfo||(e._registerWrapper({name:"react-stripe-js",version:"2.8.1"}),e.registerAppInfo({name:"react-stripe-js",version:"2.8.1",url:"https://stripe.com/docs/stripe-js/react"}))},I=d.createContext(null);I.displayName="ElementsContext";var te=function(e,r){if(!e)throw new Error("Could not find Elements context; You need to wrap the part of your app that ".concat(r," in an <Elements> provider."));return e},re=function(e){var r=e.stripe,s=e.options,i=e.children,o=d.useMemo(function(){return ke(r)},[r]),c=d.useState(function(){return{stripe:o.tag==="sync"?o.stripe:null,elements:o.tag==="sync"?o.stripe.elements(s):null}}),m=X(c,2),a=m[0],v=m[1];d.useEffect(function(){var p=!0,l=function(w){v(function(E){return E.stripe?E:{stripe:w,elements:w.elements(s)}})};return o.tag==="async"&&!a.stripe?o.stripePromise.then(function(u){u&&p&&l(u)}):o.tag==="sync"&&!a.stripe&&l(o.stripe),function(){p=!1}},[o,a,s]);var g=D(r);d.useEffect(function(){g!==null&&g!==r&&console.warn("Unsupported prop change on Elements: You cannot change the `stripe` prop after setting it.")},[g,r]);var h=D(s);return d.useEffect(function(){if(a.elements){var p=Z(s,h,["clientSecret","fonts"]);p&&a.elements.update(p)}},[s,h,a.elements]),d.useEffect(function(){Pe(a.stripe)},[a.stripe]),d.createElement(I.Provider,{value:a},i)};re.propTypes={stripe:f.any,options:f.object};var Ae=function(e){var r=d.useContext(I);return te(r,e)},Oe=function(){var e=Ae("calls useElements()"),r=e.elements;return r};f.func.isRequired;var ne=d.createContext(null);ne.displayName="CustomCheckoutSdkContext";var _e=function(e,r){if(!e)throw new Error("Could not find CustomCheckoutProvider context; You need to wrap the part of your app that ".concat(r," in an <CustomCheckoutProvider> provider."));return e},Me=d.createContext(null);Me.displayName="CustomCheckoutContext";f.any,f.shape({clientSecret:f.string.isRequired,elementsOptions:f.object}).isRequired;var z=function(e){var r=d.useContext(ne),s=d.useContext(I);if(r&&s)throw new Error("You cannot wrap the part of your app that ".concat(e," in both <CustomCheckoutProvider> and <Elements> providers."));return r?_e(r,e):te(s,e)},Re=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},y=function(e,r){var s="".concat(Re(e),"Element"),i=function(a){var v=a.id,g=a.className,h=a.options,p=h===void 0?{}:h,l=a.onBlur,u=a.onFocus,w=a.onReady,E=a.onChange,P=a.onEscape,se=a.onClick,ae=a.onLoadError,oe=a.onLoaderStart,ie=a.onNetworksChange,ce=a.onConfirm,le=a.onCancel,ue=a.onShippingAddressChange,de=a.onShippingRateChange,A=z("mounts <".concat(s,">")),O="elements"in A?A.elements:null,_="customCheckoutSdk"in A?A.customCheckoutSdk:null,pe=d.useState(null),B=X(pe,2),b=B[0],me=B[1],N=d.useRef(null),U=d.useRef(null);j(b,"blur",l),j(b,"focus",u),j(b,"escape",P),j(b,"click",se),j(b,"loaderror",ae),j(b,"loaderstart",oe),j(b,"networkschange",ie),j(b,"confirm",ce),j(b,"cancel",le),j(b,"shippingaddresschange",ue),j(b,"shippingratechange",de),j(b,"change",E);var T;w&&(e==="expressCheckout"?T=w:T=function(){w(b)}),j(b,"ready",T),d.useLayoutEffect(function(){if(N.current===null&&U.current!==null&&(O||_)){var S=null;_?S=_.createElement(e,p):O&&(S=O.create(e,p)),N.current=S,me(S),S&&S.mount(U.current)}},[O,_,p]);var $=D(p);return d.useEffect(function(){if(N.current){var S=Z(p,$,["paymentRequest"]);S&&"update"in N.current&&N.current.update(S)}},[p,$]),d.useLayoutEffect(function(){return function(){if(N.current&&typeof N.current.destroy=="function")try{N.current.destroy(),N.current=null}catch{}}},[]),d.createElement("div",{id:v,className:g,ref:U})},o=function(a){z("mounts <".concat(s,">"));var v=a.id,g=a.className;return d.createElement("div",{id:v,className:g})},c=r?o:i;return c.propTypes={id:f.string,className:f.string,onChange:f.func,onBlur:f.func,onFocus:f.func,onReady:f.func,onEscape:f.func,onClick:f.func,onLoadError:f.func,onLoaderStart:f.func,onNetworksChange:f.func,onConfirm:f.func,onCancel:f.func,onShippingAddressChange:f.func,onShippingRateChange:f.func,options:f.object},c.displayName=s,c.__elementType=e,c},x=typeof window>"u",Ie=d.createContext(null);Ie.displayName="EmbeddedCheckoutProviderContext";var Ue=function(){var e=z("calls useStripe()"),r=e.stripe;return r};y("auBankAccount",x);var Y=y("card",x);y("cardNumber",x);y("cardExpiry",x);y("cardCvc",x);y("fpxBank",x);y("iban",x);y("idealBank",x);y("p24Bank",x);y("epsBank",x);y("payment",x);y("expressCheckout",x);y("currencySelector",x);y("paymentRequestButton",x);y("linkAuthentication",x);y("address",x);y("shippingAddress",x);y("paymentMethodMessaging",x);y("affirmMessage",x);y("afterpayClearpayMessage",x);const Te=ye(void 0);function Le({onSuccess:n,onCancel:e}){const{user:r}=W(),s=Ue(),i=Oe(),[o,c]=C.useState(!1),[m,a]=C.useState(null),v=async g=>{if(g.preventDefault(),!s||!i||!r)return;const h=i.getElement(Y);if(h)try{c(!0),a(null);const{error:p,paymentMethod:l}=await s.createPaymentMethod({type:"card",card:h});if(p)throw new Error(p.message);if(!l)throw new Error("Impossible de créer la méthode de paiement");const{error:u}=await M.functions.invoke("attach-payment-method",{body:{userId:r.id,paymentMethodId:l.id}});if(u)throw u;h.clear(),n&&n()}catch(p){console.error("Error adding payment method:",p),a(p.message||"Une erreur est survenue")}finally{c(!1)}};return t.jsxs("form",{onSubmit:v,className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Carte de crédit"}),t.jsx("div",{className:"bg-white/5 border border-white/10 rounded-lg p-4",children:t.jsx(Y,{options:{style:{base:{fontSize:"16px",color:"#ffffff","::placeholder":{color:"#aab7c4"}},invalid:{color:"#ef4444"}}}})})]}),m&&t.jsx("div",{className:"bg-red-900/50 text-red-400 p-4 rounded-lg",children:m}),t.jsxs("div",{className:"flex justify-end gap-4",children:[e&&t.jsx("button",{type:"button",onClick:e,className:"btn-secondary",children:"Annuler"}),t.jsx("button",{type:"submit",disabled:!s||o,className:"btn-primary",children:o?"Traitement en cours...":"Ajouter la carte"})]})]})}function Fe(n){return t.jsx(re,{stripe:Te,children:t.jsx(Le,{...n})})}function De(){const{user:n}=W(),[e,r]=C.useState([]),[s,i]=C.useState(!0),[o,c]=C.useState(null),[m,a]=C.useState(!1);C.useEffect(()=>{n&&v()},[n]);const v=async()=>{try{i(!0),c(null);const{data:l,error:u}=await M.functions.invoke("list-payment-methods",{body:{userId:n?.id}});if(u)throw u;r(l||[])}catch(l){console.error("Error loading payment methods:",l),c(l.message||"Une erreur est survenue")}finally{i(!1)}},g=async l=>{if(confirm("Êtes-vous sûr de vouloir supprimer cette méthode de paiement ?"))try{i(!0),c(null);const{error:u}=await M.functions.invoke("detach-payment-method",{body:{userId:n?.id,paymentMethodId:l}});if(u)throw u;await v()}catch(u){console.error("Error deleting payment method:",u),c(u.message||"Une erreur est survenue")}finally{i(!1)}},h=async l=>{try{i(!0),c(null);const{error:u}=await M.functions.invoke("set-default-payment-method",{body:{userId:n?.id,paymentMethodId:l}});if(u)throw u;await v()}catch(u){console.error("Error setting default payment method:",u),c(u.message||"Une erreur est survenue")}finally{i(!1)}},p=()=>{a(!1),v()};return s&&e.length===0?t.jsx("div",{className:"flex justify-center py-6",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-400"})}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"text-lg font-medium text-white",children:"Méthodes de paiement"}),t.jsx("button",{onClick:()=>a(!m),className:"btn-secondary flex items-center gap-2",children:m?"Annuler":t.jsxs(t.Fragment,{children:[t.jsx(xe,{className:"h-5 w-5"}),"Ajouter une carte"]})})]}),o&&t.jsx("div",{className:"bg-red-900/50 text-red-400 p-4 rounded-lg",children:o}),m?t.jsx(fe.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"bg-white/5 rounded-lg p-6",children:t.jsx(Fe,{onSuccess:p,onCancel:()=>a(!1)})}):t.jsx(t.Fragment,{children:e.length===0?t.jsxs("div",{className:"bg-white/5 rounded-lg p-6 text-center",children:[t.jsx("p",{className:"text-gray-400",children:"Aucune méthode de paiement enregistrée"}),t.jsx("button",{onClick:()=>a(!0),className:"btn-primary mt-4",children:"Ajouter une carte"})]}):t.jsx("div",{className:"space-y-4",children:e.map(l=>t.jsxs("div",{className:"bg-white/5 rounded-lg p-4 flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-white font-medium capitalize",children:l.brand}),t.jsxs("span",{className:"text-gray-400",children:["•••• ",l.last4]}),l.is_default&&t.jsx("span",{className:"bg-primary-600/20 text-primary-400 text-xs px-2 py-1 rounded-full",children:"Par défaut"})]}),t.jsxs("p",{className:"text-sm text-gray-400",children:["Expire ",l.exp_month.toString().padStart(2,"0"),"/",l.exp_year]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[!l.is_default&&t.jsx("button",{onClick:()=>h(l.id),className:"text-sm text-primary-400 hover:text-primary-300",disabled:s,children:"Définir par défaut"}),t.jsx("button",{onClick:()=>g(l.id),className:"text-gray-400 hover:text-red-400",disabled:s,children:t.jsx(ve,{className:"h-5 w-5"})})]})]},l.id))})})]})}function Ve(){const{user:n,subscription:e,loadUser:r}=W(),[s,i]=C.useState(!1),[o,c]=C.useState(null),[m,a]=C.useState(null);C.useEffect(()=>{(async()=>{const l=new URLSearchParams(window.location.search).get("session_id");if(l)try{i(!0);const{success:u,data:w,error:E}=await q.checkSessionStatus(l);if(!u||E)throw new Error(E||"Une erreur est survenue lors de la vérification de la session");await r(),a("Votre abonnement a été activé avec succès !"),window.history.replaceState({},document.title,window.location.pathname)}catch(u){c(u.message||"Une erreur est survenue")}finally{i(!1)}})()},[]);const v=async()=>{if(!(!n||!e?.stripe_customer_id))try{i(!0),c(null);const{success:h,error:p}=await q.createPortalSession(e.stripe_customer_id);if(!h)throw new Error(p||"Une erreur est survenue lors de la création de la session")}catch(h){c(h.message||"Une erreur est survenue")}finally{i(!1)}},g=()=>{if(!e)return"Aucun abonnement";switch(e.status){case"trialing":return"Période d'essai";case"active":return"Actif";case"canceled":return"Annulé";case"incomplete":return"Incomplet";case"incomplete_expired":return"Expiré";case"past_due":return"Paiement en retard";case"unpaid":return"Impayé";default:return"Inconnu"}};return t.jsxs("div",{className:"space-y-6",children:[t.jsx("h2",{className:"text-lg font-medium text-white",children:"Gestion de l'abonnement"}),o&&t.jsx("div",{className:"bg-red-900/50 text-red-400 p-4 rounded-lg",children:o}),m&&t.jsx("div",{className:"bg-green-900/50 text-green-400 p-4 rounded-lg",children:m}),t.jsx("div",{className:"bg-white/5 rounded-lg p-6",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-400",children:"Statut"}),t.jsx("p",{className:"text-white font-medium",children:g()})]}),e&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-400",children:"Plan"}),t.jsx("p",{className:"text-white font-medium capitalize",children:e.plan})]}),e.current_period_end&&t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-400",children:"Prochaine facturation"}),t.jsx("p",{className:"text-white font-medium",children:L(new Date(e.current_period_end),"dd MMMM yyyy",{locale:F})})]}),e.cancel_at&&t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-400",children:"Annulation prévue le"}),t.jsx("p",{className:"text-white font-medium",children:L(new Date(e.cancel_at),"dd MMMM yyyy",{locale:F})})]})]}),n?.trial_ends_at&&new Date(n.trial_ends_at)>new Date&&t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-400",children:"Fin de la période d'essai"}),t.jsx("p",{className:"text-white font-medium",children:L(new Date(n.trial_ends_at),"dd MMMM yyyy à HH:mm",{locale:F})})]}),t.jsx("div",{className:"pt-4",children:e?.stripe_customer_id?t.jsx("button",{onClick:v,disabled:s,className:"btn-primary w-full",children:s?"Chargement...":"Gérer mon abonnement"}):t.jsx("a",{href:"/pricing",className:"btn-primary block text-center w-full",children:"Voir les plans"})})]})}),t.jsx(De,{})]})}function Ge(){const[n,e]=C.useState(!1),r="https://klwugophjvzctlautsqz.supabase.co/functions/v1/stripe-webhook",s=async()=>{try{await navigator.clipboard.writeText(r),e(!0),setTimeout(()=>e(!1),2e3)}catch(i){console.error("Erreur lors de la copie:",i)}};return t.jsxs("div",{className:"bg-white/5 rounded-lg p-6 space-y-4",children:[t.jsx("h3",{className:"text-lg font-medium text-white",children:"Configuration du webhook Stripe"}),t.jsxs("p",{className:"text-gray-300",children:["Pour configurer le webhook Stripe, vous devez ajouter l'URL suivante dans votre",t.jsx("a",{href:"https://dashboard.stripe.com/webhooks",target:"_blank",rel:"noopener noreferrer",className:"text-primary-400 hover:text-primary-300 ml-1",children:"dashboard Stripe"}),":"]}),t.jsxs("div",{className:"flex items-center gap-2 bg-white/10 p-3 rounded-lg",children:[t.jsx("code",{className:"text-sm text-white flex-1 overflow-x-auto",children:r}),t.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-white rounded-lg hover:bg-white/10",children:n?t.jsx(he,{className:"h-5 w-5 text-green-400"}):t.jsx(ge,{className:"h-5 w-5"})})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-gray-300",children:"Événements à écouter:"}),t.jsxs("ul",{className:"list-disc list-inside text-gray-300 space-y-1",children:[t.jsx("li",{children:"checkout.session.completed"}),t.jsx("li",{children:"customer.subscription.updated"}),t.jsx("li",{children:"customer.subscription.deleted"})]})]}),t.jsxs("div",{className:"mt-4 p-4 bg-white/5 rounded-lg",children:[t.jsx("h4",{className:"text-white font-medium mb-2",children:"Clé secrète Restricted Key"}),t.jsx("p",{className:"text-gray-300 mb-4",children:"Utilisez cette clé d'API restreinte pour les fonctions Edge Supabase:"}),t.jsx("div",{className:"bg-white/10 p-3 rounded-lg",children:t.jsx("code",{className:"text-sm text-white break-all",children:"rk_test_51R9nCKQIOmiow871fPTN2vLxMMSyNSorZnpqWeoV7cJKHQLKcBdr1xHJFPVzNGPmApnMB9HzDs6x4oQzArXxutNG00Ul2TpX6h"})})]}),t.jsxs("p",{className:"text-gray-300",children:[`Une fois configuré, copiez le "Signing Secret" généré par Stripe et ajoutez-le à vos variables d'environnement Supabase sous le nom `,t.jsx("code",{className:"bg-white/10 px-2 py-1 rounded",children:"STRIPE_WEBHOOK_SECRET"}),"."]}),t.jsx("div",{className:"bg-yellow-900/30 text-yellow-400 p-4 rounded-lg",children:t.jsxs("p",{className:"text-sm",children:[t.jsx("strong",{children:"Note:"})," Pour tester en local, vous pouvez utiliser l'outil Stripe CLI ou un service comme ngrok pour exposer votre serveur local à internet."]})})]})}export{De as P,Ve as S,Ge as a};
//# sourceMappingURL=StripeWebhookInfo-DAyxlWho.js.map
